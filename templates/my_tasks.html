{% extends 'base.html' %}
{% set task_id = request.view_args.get('task_id') or 0 %}
{% block nav %}
{% endblock %}
{% block body %}
    <div class="row">
    {% include 'menu.html' %}
        <div class="col-6">
            <h1>Мои задачи</h1>
            <div class="row">
                <div class="col">
                    <table class="table">
                        <thead class="table-light">
                        <tr>
                            <th class="col">#</th>
                            <th class="col ">Описание задачи</th>
                            <th class="col-1">Теги</th>
                            <th class="col-1">Дедлайн</th>
                            <th class="col-1">Естимейт</th>
                            <th class="col-1">Важность</th>
                            <th class="col-1">Состояние</th>
                        </tr>
                        </thead>
                        {% for task in tasks %}
                            <tr class="{{ active }}" id="task">
                                <td class="col-auto">{{ loop.index }}</td>
                                <td class="col-auto border-start d-none" id="task_id">{{ task.id }}</td>
                                <td class="col-auto border-start"><a
                                        href="{{ url_for('.mytask', task_id=task.id) }}">{{ task.title }}</a></td>
                                <td class="col-auto border-start text-nowrap text-success">{{ task.tags or '' }}</td>
                                <td class="col-auto border-start text-danger">{{ task.deadline.strftime('%d-%m-%Y') if task.deadline }}</td>
                                <td class="col-auto border-start text-primary">{{ task.estimate or '' }}</td>
                                <td class="col-auto border-start">{{ importance(task.importance) }}</td>
                                <td class="col-auto border-start">{{ icon_stage(task.stage) }}</td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
        <div class="col-4">
            <h1>Описание задачи {{ task_id }}</h1>
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#" id="task_desc">Описание задачи</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="task_comment">Комментарии</a>
            </li>

        </ul>
            <form class="task" id="task_desc" action="{{ url_for('.mytask', task_id=task_id, board_id=page) }}" method="post">
                {{ form.csrf_token() }}
                <label class="control-label" for="title">Заголовок</label>
                {{ form.title(class="form-control mb-3") }}
                <label class="control-label" for="description">Описание задачи</label>
                {{ form.description(class="form-control mb-3", rows=5) }}

                <div class="row">
                    <div class="col">
                    <label class="control-label" for="deadline">Дейдлайн</label>
                {{ form.deadline(class="form-control mb-3 text-danger") }}</div>
                    <div class="col">
                    <label class="control-label" for="user_id">Естимейт</label>
                {{ form.estimate(class="form-control mb-3") }}
                        </div>
                    </div>

                <div class="row">
                    <div class="col">
                <label class="control-label" for="user_id">Теги</label>
                {{ form.tags(class="form-control mb-3") }}
                </div>
                    <div class="col">
                <label class="control-label" for="board">Доска</label>
                {{ form.board(class="form-select mb-3") }}
                </div>
                    </div>
{#                <button type="submit" class="btn btn-info">Сохранить</button>#}
{#                {% set k = {'task_id':task_id, 'board_id':page} %}#}
{#                <a href="{{ url_for('.del_task', **k) }}" class="btn btn-outline-warning">Удалить задачу насовсем</a>#}
                <div class="row justify-content-between">
            <div class="col-auto offset-2">
                <input type="radio" class="btn-check" name="stage" id="dev-job" autocomplete="off" value="Dev">
                <label class="btn btn-outline-success" for="dev-job">Разработка</label>
                <input type="radio" class="btn-check" name="stage" id="dev-pause" autocomplete="off" value="Qa">
                <label class="btn btn-outline-success" for="dev-pause">Qa</label>
                <input type="radio" class="btn-check" name="stage" id="dev-continue" autocomplete="off" value="Review">
                <label class="btn btn-outline-success" for="dev-continue">Ревью</label>
                <input type="radio" class="btn-check" name="stage" id="qa-start" autocomplete="off" value="Release">
                <label class="btn btn-outline-warning" for="qa-start">Готов к релизу</label>
                <input type="radio" class="btn-check" name="stage" id="qa-pause" autocomplete="off" value="Done">
                <label class="btn btn-outline-warning" for="qa-pause">Готов</label>
            </div>
            <div class="col-auto">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{{ url_for('.mytask') }}" class="btn btn-outline-secondary">Вернуться</a></div>
                </div>
            </form>
    </div>
    </div>
{% endblock %}
{% block script %}
        <script>
        $(function () {
            let description_task = $('#description_task'), board = '{{ page }}', $task = $('tr#task');
            $('form#task_comment').hide()

            $task.each(function() {
              // В зависимости от важности покрасим строки таблицы
            if ($(this).find('#importance i').hasClass('text-danger')){
            $(this).find('#id').addClass('border-start border-5 border-danger')
            } else if ($(this).find('#importance i').hasClass('text-success')) {
                $(this).find('#id').addClass('border-start border-5 border-success')
            }
            })
            {# подсветить доску#}
            $(`#${board}`).addClass('active')
            $task.on('click', function () {
                var task_id = $(this).find('#task_id').text()
                url = '{{ url_for('.index') }}' + `${board}/` + `${task_id}`
                location.assign(url)
                description_task.focus()
            });

            $('#description_task ul li.nav-item').on('click', function () {
                // блок задача - комментарии
                $(this).find('a').addClass("active")
                $('#description_task li.nav-item').not($(this)).find('a').removeClass('active')
                if ($(this).find('a').attr('id') === 'task_comment') {
                    $('form#task_comment').show()
                    $('form').not('#task_comment').hide()
                } else {
                    $('form#task_comment').hide()
                    $('form#task_desc').show()
                }
            })
        });
        </script>
    {% endblock script %}