{% extends 'base.html' %}
{% set page = request.view_args.get('board_id') or 'Actual'%}
{% set task_id = request.view_args.get('task_id') or 0 %}

{% block nav %}
{% include 'nav.html' %}
{% endblock %}
{% block body %}
    <h1 class="mb-5 ">Доска {{ page }} {{ add_comment }}</h1>
    <div class="row">
        <div class="col-8 border-end">
            <table class="table">
            <thead class="table-light">
        <tr>
            <th class="col-auto border-start">#</th>
            <th class="col-auto border-start">Заголовок</th>
            <th class="col border-start">Теги</th>
            <th class="col border-start">Исполнитель</th>
            <th class="col border-start">Дедлайн</th>
            <th class="col border-start">Естимейт</th>
            <th class="col border-start" title="Важность"><i class="fa fa-exclamation fa-2x text-danger" ></i></th>
            <th class="col-2 border-start">Стадия</th>
        </tr>
        </thead>
        {% for task in tasks %}
            {% if task.stage == 'Dev' %}
                {% set stage='text-primary' %}
            {% elif task.stage == 'QA' %}
                {% set stage='text-warning' %}
            {% elif task.stage == 'Project' %}
                {% set stage='text-info' %}
            {% elif task.stage == 'Review' %}
                {% set stage='text-success' %}
            {% else %}
                {% set stage='d-none' %}
            {% endif %}

                {% if task_id == task.id %}
            {% set active = 'bg-info' %}
            {% endif %}
            <tr class="{{ active }}" id="task">
                <td class="col-auto">{{ loop.index }}</td>
                <td class="border-start d-none" id="task_id">{{ task.id }}</td>
                <td class="border-start"><a href="#">{{ task.title }}</a></td>
                <td class="border-start fs-6">{{ task.tags or ''}}</td>
                <td class="border-start">{{ task.user.username or ''}}</td>
                <td class="border-start text-danger">{{ task.deadline.strftime('%d-%m') if task.deadline }}</td>
                <td class="border-start text-primary">{{ task.estimate or ''}}</td>
                <td class="border-start text-primary">{{ importent(task.importance)}}</td>
                <td class="border-start text-nowrap">{{ icon_stage(task.stage) }}</td>
            </tr>
        {% endfor %}

    </table>
        </div>

    <div class="col" id="description_task">
        {% if task_id !=0 or create_task%}
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#" id="task_desc">Описание задачи</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="task_comment">Комментарии</a>
            </li>

        </ul>
            <form class="task" id="task_desc" action="{{ url_for('.index', task_id=task_id, board_id=page) }}" method="post">
                {{ form.csrf_token() }}
                <label class="control-label" for="title">Заголовок</label>
                {{ form.title(class="form-control mb-3") }}
                <label class="control-label" for="description">Описание задачи</label>
                {{ form.description(class="form-control mb-3", rows=10) }}
                <div class="row">
                <div class="col">
                <label class="control-label" for="user_id">Назначить исполнителя</label>
                {{ form.user_id(class="form-select mb-3") }}
                </div>
                <div class="col">
                <label class="control-label" for="importance">Установить важность</label>
                {{ form.importance(class="form-select mb-3") }}
                </div>
                </div>
                <div class="row">
                    <div class="col">
                    <label class="control-label" for="deadline">Дейдлайн</label>
                {{ form.deadline(class="form-control mb-3 text-danger") }}</div>
                    <div class="col">
                    <label class="control-label" for="user_id">Естимейт</label>
                {{ form.estimate(class="form-control mb-3") }}
                        </div>
                    </div>

                <div class="row">
                    <div class="col">
                <label class="control-label" for="user_id">Теги</label>
                {{ form.tags(class="form-control mb-3") }}
                </div>
                    <div class="col">
                <label class="control-label" for="board">Доска</label>
                {{ form.board(class="form-select mb-3") }}
                </div>
                    </div>
                <button type="submit" class="btn btn-info">Сохранить</button>
                {% set k = {'task_id':task_id, 'board_id':page} %}
                <a href="{{ url_for('.del_task', **k) }}" class="btn btn-outline-warning">Удалить задачу насовсем</a>
                {% else %}
                <div class="card mb-3" style="max-width: 540px;">
              <div class="row g-0">
                <div class="col-md-4">
                  <img src="{{ url_for('static', filename='placat.jpg') }}" class="img-fluid rounded-start" alt="...">
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h5 class="card-title">Card title</h5>
                    <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
                    <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>
                  </div>
                </div>
              </div>
            </div>
            <div class="card mb-3" style="max-width: 540px;">
              <div class="row g-0">
                <div class="col-md-4">
                  <img src="{{ url_for('static', filename='risunki-61.jpg') }}" class="img-fluid rounded-start" alt="...">
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h5 class="card-title">Card title</h5>
                    <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
                    <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>
                  </div>
                </div>
              </div>
            </div><div class="card mb-3" style="max-width: 540px;">
              <div class="row g-0">
                <div class="col-md-4">
                  <img src="{{ url_for('static', filename='foto-17.jpg') }}" class="img-fluid rounded-start" alt="...">
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h5 class="card-title">Card title</h5>
                    <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
                    <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>
                  </div>
                </div>
              </div>
            </div>
                {% endif %}
            </form>
        <form class="task_comment" id="task_comment"  action="{{ url_for('.task_add_comment', task_id=task_id) }}" method="post">
                {{ form_comments.csrf_token() }}
            <div id="comments">
                <ul class="list-group">
                {% for comment in comments %}
                    <li class="list-group-item">{{ comment.description }}</li>
                {% endfor %}
                </ul>
            </div>
                <label class="control-label" for="description"><h3>Новый комментарий</h3></label>
                {{ form_comments.description(class="form-control mb-3", rows=10) }}
            <button type="submit" class="btn btn-info">Добавить комментарий</button>
        </form>

{% endblock body%}

    {% block script %}
        <script>
        $(function () {
            let description_task = $('#description_task'), board = '{{ page }}', add_comment='{{ add_comment }}';
            $('form#task_comment').hide()

            {# подсветить доску#}
            $(`#${board}`).addClass('active')

            $('tr#task').on('click', function () {
                var task_id = $(this).find('#task_id').text()
                url = '{{ url_for('.index') }}' + `${board}/` + `${task_id}`
                location.assign(url)
                description_task.focus()
            });

            $('#description_task ul li.nav-item').on('click', function () {
                // блок задача - комментарии
                $(this).find('a').addClass("active")
                $('#description_task li.nav-item').not($(this)).find('a').removeClass('active')
                if ($(this).find('a').attr('id') === 'task_comment') {
                    $('form#task_comment').show()
                    $('form').not('#task_comment').hide()
                } else {
                    $('form#task_comment').hide()
                    $('form#task_desc').show()
                }
            })
        });
        </script>
    {% endblock script %}
