{% extends 'base.html' %}
{% set page = request.view_args.get('board_id') or 'Actual'%}

{% block body %}
    <h1>Доска {{ page }}</h1>
    <div class="row">
        <div class="col-8 border-end">
            <table class="table table-striped ">
        <thead>
        <tr>
            <th>Заголовок</th>
            <th>Теги</th>
            <th>Дата создания</th>
            <th>Исполнитель</th>
            <th>Дедлайн</th>
            <th>Естимейт</th>
        </tr>
        </thead>
        {% for task in tasks %}
            <tr id="task">
                <td class="col-auto border-start d-none" id="task_id">{{ task.id }}</td>
                <td class="col-auto border-start"><a  href="#">{{ task.title }}</a></td>
                <td class="col-auto border-start fs-6">{{ task.tags or ''}}</td>
                <td class="col-auto border-start">{{ task.created.strftime('%d-%m') }}</td>
                <td class="col-auto border-start">{{ task.user.username or ''}}</td>
                <td class="col-auto border-start text-danger">{{ task.deadline.strftime('%d-%m-%Y') if task.deadline }}</td>
                <td class="col-auto border-start text-primary">{{ task.estimate or ''}}</td>
            </tr>
        {% endfor %}

    </table>
        </div>
        <div class="col" id="description_task"> Описание задачи
            <form action="" method="post">
                {{ form.csrf_token() }}
                <label class="control-label" for="title">Заголовок</label>
                {{ form.title(class="form-control mb-3") }}
                <label class="control-label" for="description">Описание задачи</label>
                {{ form.description(class="form-control mb-3", rows=10) }}
                <label class="control-label" for="user_id">Назначить исполнителя</label>
                {{ form.user_id(class="form-select mb-3") }}
                <label class="control-label" for="deadline">Дейдлайн</label>
                {{ form.deadline(class="form-control mb-3 ") }}
                <label class="control-label" for="user_id">Естимейт</label>
                {{ form.estimate(class="form-control mb-3") }}
                <label class="control-label" for="user_id">Теги</label>
                {{ form.tags(class="form-control mb-3") }}

                <hr>
                <label class="control-label" for="board">Перенести на другую доску</label>
                {{ form.board(class="form-select mb-3") }}
                <button type="submit" class="btn btn-info">Сохранить</button>
            </form>
        </div>

{% endblock body%}

    {% block script %}
        <script>
        $(function () {
        let $li = $('li.nav-item'), page = '{{ page }}';
            $li.each(function () {
                if ($(this).find('a').attr('href') === '/board/' + page) {
                    $(this).find('a').addClass('active')

                }
            })
            $('tr#task').on('click', function (event) {
                event.preventDefault()

                const today = new Date();
                const dateSrc = today.toLocaleString('ru-RU', { year: 'numeric', month: 'numeric', day: 'numeric' });

                dateDst = dateSrc.split(".").reverse().join("-");

                $('#description_task').focus()
                $(this).addClass('bg-info')
                p = $('tr#task').not($(this))
                p.removeClass('bg-info')
                $.ajax({
                    url: `${$(this).find('#task_id').text()}`,
                    method: 'get',
                    dataType: 'html',
                    success: function (data) {
                        const obj = JSON.parse(data);
                        let title = $('#description_task #title');
                        title.focus()
                        title.val(obj.title)

                        $('#description_task #description').val(obj.description)
                        $('#description_task #user_id').val(obj.user_id)
                        $('#description_task #board').val(obj.board)
                        $('#description_task #estimate').val(obj.estimate)


                        if (obj.deadline) {
                            deadline = new Date(obj.deadline)
                            month = (deadline.getMonth()+1).toString().padStart(2, "0");
                            day = deadline.getDate().toString().padStart(2, "0");
                            year = deadline.getUTCFullYear()
                            $('#description_task #deadline').val(`${year}-${month}-${day}`)
                        } else {
                            $('#description_task #deadline').val('')
                        }

                        $('form').attr('action', `/${obj.id}`)
                    }
                })
        })
        });
        </script>

        <script type="text/javascript">

        </script>


    {% endblock script %}
